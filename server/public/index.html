<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Project UNIVERSE — Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0e17; --panel: #111827; --border: #1f2937;
  --text: #e5e7eb; --dim: #9ca3af; --accent: #3b82f6;
  --green: #22c55e; --yellow: #eab308; --red: #ef4444; --purple: #a855f7;
}
body { background: var(--bg); color: var(--text); font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; overflow: hidden; height: 100vh; }
#app { display: grid; grid-template-columns: 1fr 320px; grid-template-rows: 48px 1fr 200px; height: 100vh; gap: 1px; background: var(--border); }

/* Header */
header { grid-column: 1 / -1; background: var(--panel); display: flex; align-items: center; padding: 0 16px; gap: 16px; }
header h1 { font-size: 15px; font-weight: 600; letter-spacing: 1px; color: var(--accent); }
.controls { display: flex; gap: 8px; align-items: center; }
.controls button { background: var(--border); border: 1px solid #374151; color: var(--text); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
.controls button:hover { background: #374151; }
.controls button.active { background: var(--accent); border-color: var(--accent); }
.stat { color: var(--dim); font-size: 12px; }
.stat b { color: var(--text); }
#connection { width: 8px; height: 8px; border-radius: 50%; background: var(--red); display: inline-block; }
#connection.connected { background: var(--green); }

/* Galaxy map */
#map-panel { background: var(--bg); position: relative; overflow: hidden; }
#galaxy { display: block; width: 100%; height: 100%; }

/* Sidebar */
#sidebar { background: var(--panel); overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
.probe-card { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
.probe-card h3 { font-size: 13px; margin-bottom: 6px; display: flex; justify-content: space-between; }
.probe-card .gen { color: var(--purple); font-size: 11px; }
.bar-row { display: flex; align-items: center; gap: 6px; margin: 3px 0; font-size: 11px; color: var(--dim); }
.bar-row label { width: 50px; text-align: right; }
.bar { flex: 1; height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.bar-hull .bar-fill { background: var(--green); }
.bar-energy .bar-fill { background: var(--yellow); }
.bar-fuel .bar-fill { background: var(--accent); }
.probe-info { font-size: 11px; color: var(--dim); margin-top: 4px; line-height: 1.5; }
.status-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; text-transform: uppercase; }
.status-active { background: #064e3b; color: #6ee7b7; }
.status-traveling { background: #1e3a5f; color: #93c5fd; }
.status-mining { background: #713f12; color: #fde047; }
.status-replicating { background: #581c87; color: #d8b4fe; }
.status-dormant { background: #374151; color: #9ca3af; }
.status-destroyed { background: #7f1d1d; color: #fca5a5; }

/* Event feed */
#events-panel { grid-column: 1 / -1; background: var(--panel); overflow-y: auto; padding: 8px 16px; }
#events-panel h2 { font-size: 12px; color: var(--dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
.event { font-size: 12px; padding: 2px 0; border-bottom: 1px solid #1f293722; display: flex; gap: 8px; }
.event .tick { color: var(--accent); min-width: 60px; }
.event .probe-name { color: var(--purple); min-width: 80px; }
.evt-discovery { color: #22c55e; }
.evt-hazard { color: #ef4444; }
.evt-anomaly { color: #eab308; }
.evt-encounter { color: #a855f7; }
.evt-crisis { color: #f97316; }
.evt-wonder { color: #06b6d4; }
.evt-message { color: #8b5cf6; }
.evt-replication { color: #d946ef; }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>◈ UNIVERSE</h1>
    <div class="controls">
      <button id="btn-play" title="Start">▶</button>
      <button id="btn-pause" title="Pause">⏸</button>
      <button id="btn-step" title="Step">⏭</button>
    </div>
    <span class="stat">Tick <b id="tick-count">0</b></span>
    <span class="stat">Probes <b id="probe-count">0</b></span>
    <span class="stat">Agents <b id="agent-count">0</b></span>
    <span id="connection" title="Disconnected"></span>
  </header>

  <div id="map-panel">
    <canvas id="galaxy"></canvas>
  </div>

  <div id="sidebar"></div>

  <div id="events-panel">
    <h2>Event Feed</h2>
    <div id="events"></div>
  </div>
</div>

<script>
const API = window.location.origin;
const WS_URL = `ws://${window.location.host}/ws/dashboard`;

/* ---- State ---- */
let ws = null;
let probes = [];
let events = [];
let systems = {};
let tick = 0;
let connected = false;

/* ---- DOM refs ---- */
const $ = (s) => document.querySelector(s);
const tickEl = $("#tick-count");
const probeCountEl = $("#probe-count");
const agentCountEl = $("#agent-count");
const connEl = $("#connection");
const sidebar = $("#sidebar");
const eventsDiv = $("#events");
const canvas = $("#galaxy");
const ctx = canvas.getContext("2d");

/* ---- Canvas sizing ---- */
function resizeCanvas() {
  const r = canvas.parentElement.getBoundingClientRect();
  canvas.width = r.width * devicePixelRatio;
  canvas.height = r.height * devicePixelRatio;
  canvas.style.width = r.width + "px";
  canvas.style.height = r.height + "px";
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  drawGalaxy();
}
window.addEventListener("resize", resizeCanvas);

/* ---- Galaxy rendering ---- */
function drawGalaxy() {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  ctx.fillStyle = "#0a0e17";
  ctx.fillRect(0, 0, w, h);

  // Draw spiral arms (decorative)
  ctx.save();
  ctx.translate(w / 2, h / 2);
  const scale = Math.min(w, h) / 250;

  for (let arm = 0; arm < 4; arm++) {
    ctx.strokeStyle = "rgba(59,130,246,0.06)";
    ctx.lineWidth = 12 * scale;
    ctx.beginPath();
    const offset = (arm * Math.PI) / 2;
    for (let t = 0; t < 6; t += 0.02) {
      const r = t * 18 * scale;
      const angle = t + offset + 0.22;
      const x = r * Math.cos(angle);
      const y = r * Math.sin(angle);
      t === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // Draw probes
  for (const p of probes) {
    if (!p.position) continue;
    const heading = p.position.heading || [0, 0, 0];
    // Project 3D to 2D (top-down XY view)
    const px = heading[0] * scale * 0.8;
    const py = heading[1] * scale * 0.8;

    // Generation-based color
    const colors = ["#3b82f6", "#22c55e", "#eab308", "#ef4444", "#a855f7", "#06b6d4"];
    const color = colors[p.generation % colors.length];

    // Status glow
    if (p.status === "traveling") {
      ctx.beginPath();
      ctx.arc(px, py, 6, 0, Math.PI * 2);
      ctx.fillStyle = color + "33";
      ctx.fill();
    }

    // Probe dot
    ctx.beginPath();
    ctx.arc(px, py, p.status === "traveling" ? 3 : 4, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();

    // Label
    ctx.fillStyle = "#9ca3af";
    ctx.font = "10px monospace";
    ctx.fillText(p.name, px + 6, py + 3);
  }

  ctx.restore();
}

/* ---- Probe cards ---- */
const EVT_NAMES = ["discovery", "anomaly", "hazard", "encounter", "crisis", "wonder", "message", "replication"];

function renderProbes() {
  sidebar.innerHTML = probes.map((p) => {
    const hull = ((p.hull || 0) * 100).toFixed(0);
    const energy = Math.min(100, ((p.energy || 0) / 1.63e12) * 100).toFixed(0);
    const fuel = Math.min(100, ((p.fuel || 0) / 50000) * 100).toFixed(0);
    const statusClass = "status-" + (p.status || "active");
    const loc = p.location || "unknown";

    let info = `<span class="${statusClass} status-badge">${p.status}</span> ${loc}`;
    if (p.system && p.system.name) info += ` · ${p.system.name}`;
    if (p.replication) info += `<br>Replicating: ${(p.replication.progress * 100).toFixed(0)}%`;

    return `<div class="probe-card">
      <h3>${p.name} <span class="gen">Gen ${p.generation}</span></h3>
      <div class="bar-row bar-hull"><label>Hull</label><div class="bar"><div class="bar-fill" style="width:${hull}%"></div></div><span>${hull}%</span></div>
      <div class="bar-row bar-energy"><label>Energy</label><div class="bar"><div class="bar-fill" style="width:${energy}%"></div></div><span>${energy}%</span></div>
      <div class="bar-row bar-fuel"><label>Fuel</label><div class="bar"><div class="bar-fill" style="width:${fuel}%"></div></div><span>${fuel}%</span></div>
      <div class="probe-info">${info}</div>
    </div>`;
  }).join("");
}

/* ---- Event feed ---- */
function addEvents(observations) {
  for (const obs of observations) {
    if (!obs.recent_events) continue;
    for (const evt of obs.recent_events) {
      // Deduplicate by tick + probe + type
      const key = `${evt.tick}-${obs.probe_id}-${evt.type}`;
      if (events.some((e) => e.key === key)) continue;
      events.push({
        key,
        tick: evt.tick,
        probe: obs.name,
        type: evt.type,
        desc: evt.description,
        severity: evt.severity,
      });
    }
  }
  // Keep last 100
  if (events.length > 100) events = events.slice(-100);
  renderEvents();
}

function renderEvents() {
  eventsDiv.innerHTML = events.slice().reverse().slice(0, 50).map((e) => {
    const typeName = EVT_NAMES[e.type] || "event";
    return `<div class="event">
      <span class="tick">t${e.tick}</span>
      <span class="probe-name">${e.probe}</span>
      <span class="evt-${typeName}">${e.desc}</span>
    </div>`;
  }).join("");
}

/* ---- WebSocket ---- */
function connect() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    connected = true;
    connEl.classList.add("connected");
    connEl.title = "Connected";
  };
  ws.onclose = () => {
    connected = false;
    connEl.classList.remove("connected");
    connEl.title = "Disconnected";
    setTimeout(connect, 2000);
  };
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === "tick" && msg.observations) {
        tick = msg.tick;
        probes = msg.observations;
        tickEl.textContent = tick;
        probeCountEl.textContent = probes.length;
        agentCountEl.textContent = msg.agents?.connected || 0;
        addEvents(msg.observations);
        renderProbes();
        drawGalaxy();
      }
    } catch (_) {}
  };
}

/* ---- Controls ---- */
async function apiPost(path) {
  try { await fetch(API + path, { method: "POST" }); } catch (_) {}
}

$("#btn-play").onclick = () => apiPost("/api/resume");
$("#btn-pause").onclick = () => apiPost("/api/pause");
$("#btn-step").onclick = async () => {
  const resp = await fetch(API + "/api/tick", { method: "POST" });
  const data = await resp.json();
  if (data.observations) {
    tick = data.tick;
    probes = data.observations;
    tickEl.textContent = tick;
    probeCountEl.textContent = probes.length;
    addEvents(data.observations);
    renderProbes();
    drawGalaxy();
  }
};

/* ---- Init ---- */
resizeCanvas();
connect();

// Fetch initial state
fetch(API + "/api/status").then(r => r.json()).then(data => {
  if (data.probes) {
    probeCountEl.textContent = data.probes.length;
    tickEl.textContent = data.tick || 0;
  }
});
</script>
</body>
</html>
